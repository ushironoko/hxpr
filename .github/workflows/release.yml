name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.5.2)"
        required: true
        type: string
      bump_sha:
        description: "SHA of the version bump commit"
        required: true
        type: string

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: or

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.bump_sha }}

      - name: Verify all actions are pinned to SHA
        run: |
          UNPINNED=$(grep -rn 'uses:' .github/workflows/*.yml \
            | grep -v '@[0-9a-f]\{40\}' \
            | grep -v '^\s*#' \
            | grep -v "grep -rn 'uses:'" || true)
          if [ -n "$UNPINNED" ]; then
            echo "::error::Found actions not pinned to commit SHA:"
            echo "$UNPINNED"
            exit 1
          fi

      - name: Validate semver format
        env:
          VERSION: ${{ inputs.version }}
        run: |
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid semver format: $VERSION"
            exit 1
          fi

      - name: Validate bump_sha is HEAD of origin/main
        env:
          BUMP_SHA: ${{ inputs.bump_sha }}
        run: |
          MAIN_HEAD=$(git ls-remote origin refs/heads/main | awk '{print $1}')
          if [ "$MAIN_HEAD" != "$BUMP_SHA" ]; then
            echo "::error::bump_sha ($BUMP_SHA) is not the current HEAD of origin/main ($MAIN_HEAD)"
            exit 1
          fi

      - name: Verify version matches Cargo.toml
        env:
          VERSION: ${{ inputs.version }}
        run: |
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ "$CARGO_VERSION" != "$VERSION" ]; then
            echo "::error::Input version ($VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

      - name: Check tag does not already exist
        env:
          VERSION: ${{ inputs.version }}
        run: |
          if git ls-remote --tags origin "refs/tags/v${VERSION}" | grep -q .; then
            echo "::error::Tag v${VERSION} already exists"
            exit 1
          fi

  test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.bump_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Run tests
        run: cargo test

  build:
    needs: [validate, test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            use_cross: false
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            use_cross: true
          - target: x86_64-apple-darwin
            runner: macos-latest
            use_cross: false
          - target: aarch64-apple-darwin
            runner: macos-latest
            use_cross: false
    runs-on: ${{ matrix.runner }}
    env:
      ARCHIVE_NAME: octorus-${{ inputs.version }}-${{ matrix.target }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.bump_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --version 0.2.5

      - name: Build release binary
        env:
          USE_CROSS: ${{ matrix.use_cross }}
          TARGET: ${{ matrix.target }}
        run: |
          if [ "$USE_CROSS" = "true" ]; then
            cross build --release --target "$TARGET"
          else
            cargo build --release --target "$TARGET"
          fi

      - name: Create archive
        env:
          TARGET: ${{ matrix.target }}
        run: |
          mkdir -p "${ARCHIVE_NAME}"
          cp "target/${TARGET}/release/${BINARY_NAME}" "${ARCHIVE_NAME}/"
          cp README.md "${ARCHIVE_NAME}/"
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: |
            ${{ env.ARCHIVE_NAME }}.tar.gz
            ${{ env.ARCHIVE_NAME }}.tar.gz.sha256
          retention-days: 1

  release:
    needs: [validate, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.bump_sha }}

      - name: Create and push tag
        env:
          VERSION: ${{ inputs.version }}
          BUMP_SHA: ${{ inputs.bump_sha }}
        run: |
          git tag "v${VERSION}" "$BUMP_SHA"
          git push origin "v${VERSION}"

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes \
            artifacts/*

  publish:
    needs: [validate, release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.bump_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Obtain token via trusted publishing
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1
        id: auth

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: cargo publish -p octorus

  rollback:
    needs: [validate, test, build, release]
    if: always() && (needs.test.result == 'failure' || needs.build.result == 'failure' || needs.release.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check if HEAD is still the bump commit
        id: check
        env:
          BUMP_SHA: ${{ inputs.bump_sha }}
        run: |
          HEAD_SHA=$(git rev-parse HEAD)
          if [ "$HEAD_SHA" != "$BUMP_SHA" ]; then
            echo "::warning::HEAD ($HEAD_SHA) has moved past bump commit ($BUMP_SHA). Skipping revert."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Revert bump commit
        if: steps.check.outputs.skip != 'true'
        env:
          BUMP_SHA: ${{ inputs.bump_sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git revert --no-edit "$BUMP_SHA"
          git push origin main

      - name: Delete tag
        if: always()
        continue-on-error: true
        env:
          VERSION: ${{ inputs.version }}
        run: git push origin --delete "v${VERSION}"

      - name: Delete GitHub Release
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: gh release delete "v${VERSION}" --yes
